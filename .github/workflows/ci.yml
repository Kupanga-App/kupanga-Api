name: CI Kupanga

on:
  push:
    branches:
      - main
      - develop
      - 'feature/*'

jobs:
  build-test-static-docker:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1   # Active le build Docker optimis√©

    services:
      # -----------------------------
      # Base de donn√©es PostgreSQL
      # -----------------------------
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: kupanga
          POSTGRES_PASSWORD: devpassword
          POSTGRES_DB: kupanga_dev
        options: >-
          --health-cmd="pg_isready -U kupanga"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      # -----------------------------
      # Minio pour le stockage d'objets
      # -----------------------------
      minio:
        image: minio/minio
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
          - 9001:9001
        options: >-
          --health-cmd="curl -f http://localhost:9000/minio/health/live || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          server /data --console-address ":9001"

    steps:
      # -----------------------------
      # 1Ô∏è‚É£ R√©cup√©rer le code depuis GitHub
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Message
        run: echo "üì• Code r√©cup√©r√© depuis le d√©p√¥t GitHub"

      # -----------------------------
      # 2Ô∏è‚É£ Installer Java 21
      # -----------------------------
      - name: Installer Java 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Message
        run: echo "‚òï Java 21 install√©"

      # -----------------------------
      # 3Ô∏è‚É£ Build Maven sans tests
      # -----------------------------
      - name: Build Maven sans tests
        run: |
          echo "üî® Compilation du projet Maven (tests ignor√©s pour le moment)"
          mvn clean install -DskipTests

      # -----------------------------
      # 4Ô∏è‚É£ Lancer les tests unitaires
      # -----------------------------
      - name: Lancer tests unitaires
        run: |
          echo "üß™ Lancement des tests unitaires"
          mvn test

      # -----------------------------
      # 5Ô∏è‚É£ Analyse statique avec Semgrep
      # -----------------------------
      - name: Analyse statique Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/java

      - name: Message
        run: echo "üîç Analyse statique du code termin√©e avec Semgrep"

      # -----------------------------
      # 6Ô∏è‚É£ Build Docker image pour test local
      # -----------------------------
      - name: Build Docker image
        run: |
          echo "üê≥ Construction de l'image Docker pour test local"
          docker build -t kupanga-ci-test:latest .

      # -----------------------------
      # 7Ô∏è‚É£ V√©rification des services PostgreSQL et Minio
      # -----------------------------
      - name: V√©rification PostgreSQL et Minio
        run: |
          echo "‚úÖ V√©rification de la connexion √† PostgreSQL..."
          PGPASSWORD=devpassword psql -h ${{ job.services.postgres.host }} -U kupanga -d kupanga_dev -c '\l' || echo "‚ö†Ô∏è PostgreSQL non accessible"

          echo "‚úÖ V√©rification de la connexion √† Minio..."
          curl -s http://${{ job.services.minio.host }}:9000/minio/health/live || echo "‚ö†Ô∏è Minio non accessible"
